name: "Test Report"

on:
  workflow_run:
    workflows: ["Build & Test"]
    types:
      - completed

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  report:
    name: "Publish Test Report"
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Download Test Reports
        uses: actions/download-artifact@v7
        with:
          name: test-reports
          path: test-reports
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v6
        with:
          report_paths: 'test-reports/TEST-*.xml'
          include_passed: true
          detailed_summary: true
          check_name: 'Java SDK Test Results'
          commit: ${{ github.event.workflow_run.head_sha }}

      - name: Generate Test Summary
        run: |
          echo "## ðŸ§ª Java SDK Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "test-reports" ]; then
            TESTS_RUN=$(grep -h "tests=" test-reports/TEST-*.xml 2>/dev/null | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -h "failures=" test-reports/TEST-*.xml 2>/dev/null | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -h "errors=" test-reports/TEST-*.xml 2>/dev/null | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -h "skipped=" test-reports/TEST-*.xml 2>/dev/null | sed 's/.*skipped="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')

            TESTS_RUN=${TESTS_RUN:-0}
            FAILURES=${FAILURES:-0}
            ERRORS=${ERRORS:-0}
            SKIPPED=${SKIPPED:-0}
            PASSED=$((TESTS_RUN - FAILURES - ERRORS - SKIPPED))

            if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ’¥ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | $TESTS_RUN |" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Test Classes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Class | Tests | Passed | Failed | Errors | Time |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|--------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY

            for file in test-reports/TEST-*.xml; do
              if [ -f "$file" ]; then
                CLASS=$(basename "$file" .xml | sed 's/TEST-//')
                T=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
                F=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
                E=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
                TIME=$(grep -o 'time="[0-9.]*"' "$file" | head -1 | sed 's/[^0-9.]//g')
                P=$((T - F - E))

                STATUS="âœ…"
                if [ "${F:-0}" -gt 0 ] || [ "${E:-0}" -gt 0 ]; then
                  STATUS="âŒ"
                fi

                echo "| $STATUS $CLASS | ${T:-0} | ${P:-0} | ${F:-0} | ${E:-0} | ${TIME:-0}s |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "âš ï¸ No test reports found" >> $GITHUB_STEP_SUMMARY
          fi
